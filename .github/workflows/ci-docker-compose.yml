name: Docker Swarm CI

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      ###########################
      #      CONFIGURATION      #
      ###########################
      - name: ðŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: âš™ï¸ Configurer Docker et Swarm
        run: |
          docker swarm init || true

      - name: ðŸ”Ž VÃ©rifier l'existence des fichiers
        run: |
          for service in suricata wazuh elk opencti; do
            ls -l $service/docker-compose.yml || exit 1
          done

      ###########################
      #      DÃ‰PLOIEMENT        #
      ###########################
      - name: ðŸš€ DÃ©ployer les services
        run: |
          for service in suricata wazuh elk opencti; do
            docker stack deploy -c $service/docker-compose.yml $service 2>&1 | tee logs_$service.txt || echo "${service^^}_FAILED=true" >> $GITHUB_ENV
            sleep 10
          done

      ###########################
      #        NETTOYAGE        #
      ###########################
      - name: ðŸ—‘ï¸ Nettoyer les services
        run: |
          for service in suricata wazuh elk opencti; do
            docker stack rm $service || true
          done

      ###########################
      #  DÃ‰TECTION DES ERREURS  #
      ###########################
      - name: ðŸš¨ VÃ©rifier les erreurs
        run: |
          echo "TEST_FAILED=false" >> $GITHUB_ENV

          for service in suricata wazuh elk opencti; do
            log_file="logs_$service.txt"
            if [[ -f "$log_file" && $(grep -i "error\|failed\|cannot" "$log_file") ]]; then
              echo "TEST_FAILED=true" >> $GITHUB_ENV
              break
            fi
          done

      ###########################
      #   GESTION DES BRANCHES  #
      ###########################
      - name: ðŸ·ï¸ DÃ©terminer la branche cible
        id: branch_target
        run: |
          echo "TEST_FAILED=${{ env.TEST_FAILED }}"  
          if [[ "${{ env.TEST_FAILED }}" == "true" ]]; then
            TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
            echo "BRANCH=erreur-$TIMESTAMP" >> $GITHUB_ENV
          else
            echo "BRANCH=develop" >> $GITHUB_ENV
          fi

      ###########################
      #   GÃ‰NÃ‰RATION DES LOGS   #
      ###########################
      - name: ðŸ“ GÃ©nÃ©rer le fichier de logs
        if: env.TEST_FAILED == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" > error-log.txt
          echo "              ðŸ› ï¸ LOG DU PIPELINE ðŸ› ï¸              " >> error-log.txt
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> error-log.txt
          echo "ðŸ“… Date : $(date)" >> error-log.txt
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> error-log.txt

          echo "â„¹ï¸  Docker Info :" >> error-log.txt
          docker info >> error-log.txt 2>&1
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> error-log.txt
          echo "â„¹ï¸  Docker Version :" >> error-log.txt
          docker version >> error-log.txt 2>&1

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> error-log.txt
          echo "â„¹ï¸  Liste des Stacks Docker :" >> error-log.txt
          docker stack ls >> error-log.txt 2>&1

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> error-log.txt
          echo "â„¹ï¸  Liste des Services Swarm :" >> error-log.txt
          docker service ls >> error-log.txt 2>&1

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> error-log.txt
          echo "â„¹ï¸  Liste des Conteneurs en cours d'exÃ©cution :" >> error-log.txt
          docker ps -a >> error-log.txt 2>&1

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> error-log.txt
          echo "âŒ Logs dÃ©taillÃ©s des services Ã©chouÃ©s :" >> error-log.txt
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> error-log.txt

          for service in suricata wazuh elk opencti; do
            log_file="logs_$service.txt"
            if [[ -f "$log_file" ]]; then
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> error-log.txt
              echo "âŒ ERREUR DE DÃ‰PLOIEMENT POUR $service :" >> error-log.txt
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> error-log.txt
              cat "$log_file" >> error-log.txt
            fi
          done

          for service in suricata wazuh elk opencti; do
            if docker stack ps $service 2>/dev/null | grep -q "Failed\|Rejected\|Shutdown\|Complete"; then
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> error-log.txt
              echo "ðŸ” Logs pour service: $service" >> error-log.txt
              docker service logs $service >> error-log.txt 2>&1
            else
              echo "âš ï¸ Service $service non actif ou introuvable, impossible de rÃ©cupÃ©rer les logs." >> error-log.txt
            fi
          done

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> error-log.txt
          echo "ðŸ“Œ FIN DU LOG" >> error-log.txt
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> error-log.txt

          git add error-log.txt

      ###########################
      #   PUSH DES MODIFICATIONS  #
      ###########################
      - name: ðŸš€ CrÃ©er et Pousser la branche
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@github.com"

          git checkout -b ${{ env.BRANCH }}
          git commit -m "Mise Ã  jour automatique via GitHub Actions" || echo "Aucune modification Ã  commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ${{ env.BRANCH }} --force
