name: Docker Compose CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Cloner le d√©p√¥t
      uses: actions/checkout@v3

    - name: ‚öôÔ∏è Configurer Docker
      uses: docker/setup-buildx-action@v2

    # Test des services Suricata
    # - name: üõ°Ô∏è Lancer les services Suricata
    #   run: |
    #     docker compose -f Suricata/Docker-compose.yml up -d --build

    # - name: ‚úÖ V√©rifier l'√©tat de Suricata
    #   run: |
    #     docker compose -f Suricata/docker-compose.yml ps
    #     docker exec suricata suricata -V || exit 1

    # Test des services Wazuh
    - name: üìä Lancer les services Wazuh
      run: |
        docker compose -f wazuh/docker-compose.yml up -d --build

    # - name: ‚úÖ V√©rifier l'√©tat de Wazuh
    #   run: |
    #     docker compose -f wazuh/docker-compose.yml ps
    #     curl -f http://localhost:5601 || exit 1  # V√©rifie le dashboard
    #     curl -f http://localhost:55000 || exit 1  # V√©rifie l'API Wazuh

    # Test des services ELK
    - name: üìà Lancer les services ELK
      run: |
        docker compose -f ELK/Docker-compose.yml up -d --build

    # - name: ‚úÖ V√©rifier l'√©tat de ELK
    #   run: |
    #     docker compose -f ELK/Docker-compose.yml ps
    #     curl -f http://localhost:5601 || exit 1  # V√©rifie Kibana
    #     curl -f http://localhost:9200 || exit 1  # V√©rifie Elasticsearch

    # Test des services OpenCTI
    - name: üîç Lancer les services OpenCTI
      run: |
        docker compose -f opencti/docker-compose.yml up -d --build

    # - name: ‚úÖ V√©rifier l'√©tat de OpenCTI
    #   run: |
    #     docker compose -f opencti/docker-compose.yml ps
    #     curl -f http://localhost:8080 || exit 1  # V√©rifie l'interface OpenCTI

    - name: üóëÔ∏è Nettoyer les services
      run: |
        docker compose -f Suricata/docker-compose.yml down
        docker compose -f wazuh/docker-compose.yml down
        docker compose -f ELK/Docker-compose.yml down
        docker compose -f opencti/docker-compose.yml down
